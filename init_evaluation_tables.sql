-- ML Evaluation System Tables
-- Run this script on the Oracle database to create tables for the evaluation system

-- =====================================================
-- Table: ML_CONFIG_RECOMMENDATIONS
-- Purpose: Store recommendations generated by evaluation_service.py
--          Pending human approval before applying to ML service
-- =====================================================

CREATE TABLE ML_CONFIG_RECOMMENDATIONS (
    REC_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    REC_TYPE VARCHAR2(50) NOT NULL,           -- 'churn_threshold', 'churn_keywords', 'classification_fix'
    REC_DETAILS CLOB,                         -- JSON with recommendation details
    STATUS VARCHAR2(20) DEFAULT 'PENDING',    -- PENDING, APPROVED, REJECTED
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    APPROVED_BY VARCHAR2(100),
    APPROVED_AT TIMESTAMP,
    NOTES VARCHAR2(500)                       -- Optional human notes
);

-- Index for faster status queries
CREATE INDEX idx_rec_status ON ML_CONFIG_RECOMMENDATIONS(STATUS);

-- Index for date-based queries
CREATE INDEX idx_rec_created ON ML_CONFIG_RECOMMENDATIONS(CREATED_AT);

COMMENT ON TABLE ML_CONFIG_RECOMMENDATIONS IS 'ML config recommendations awaiting human approval';
COMMENT ON COLUMN ML_CONFIG_RECOMMENDATIONS.REC_TYPE IS 'Type: churn_threshold, churn_keywords, classification_fix';
COMMENT ON COLUMN ML_CONFIG_RECOMMENDATIONS.STATUS IS 'PENDING=awaiting review, APPROVED=applied to S3, REJECTED=dismissed';

-- =====================================================
-- Table: ML_CLASSIFICATION_FEEDBACK
-- Purpose: Store human corrections to ML classifications
--          Used by evaluation_service.py to identify patterns
-- =====================================================

CREATE TABLE ML_CLASSIFICATION_FEEDBACK (
    FEEDBACK_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    CALL_ID VARCHAR2(50) NOT NULL,            -- Reference to CONVERSATION_SUMMARY.SOURCE_ID
    ML_CATEGORY VARCHAR2(255),                -- What ML predicted
    CORRECT_CATEGORY VARCHAR2(255),           -- What human said is correct (NULL if ML was correct)
    IS_CORRECT NUMBER(1) DEFAULT 0,           -- 1 if ML was right, 0 if wrong
    REVIEWER VARCHAR2(100),                   -- Who reviewed
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    NOTES VARCHAR2(500)                       -- Optional reviewer notes
);

-- Index for call lookups
CREATE INDEX idx_feedback_call ON ML_CLASSIFICATION_FEEDBACK(CALL_ID);

-- Index for finding incorrect classifications
CREATE INDEX idx_feedback_correct ON ML_CLASSIFICATION_FEEDBACK(IS_CORRECT);

-- Index for reviewer queries
CREATE INDEX idx_feedback_reviewer ON ML_CLASSIFICATION_FEEDBACK(REVIEWER);

COMMENT ON TABLE ML_CLASSIFICATION_FEEDBACK IS 'Human feedback on ML classification accuracy';
COMMENT ON COLUMN ML_CLASSIFICATION_FEEDBACK.IS_CORRECT IS '1=ML was correct, 0=ML was wrong';

-- =====================================================
-- Table: ML_EVALUATION_HISTORY
-- Purpose: Store weekly evaluation run results for tracking
-- =====================================================

CREATE TABLE ML_EVALUATION_HISTORY (
    EVAL_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    EVAL_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    CHURNED_COUNT NUMBER,                     -- Total churned customers analyzed
    WITH_SCORE_COUNT NUMBER,                  -- Customers with churn_score
    RECALL_RATE NUMBER(5,4),                  -- Recall metric (0.0000 to 1.0000)
    COVERAGE_RATE NUMBER(5,4),                -- Pipeline coverage metric
    AVG_CHURN_SCORE NUMBER(5,2),              -- Average churn score of churners
    RECOMMENDATIONS_GENERATED NUMBER,         -- How many recommendations created
    NOTES CLOB                                -- JSON with additional metrics
);

-- Index for date queries
CREATE INDEX idx_eval_date ON ML_EVALUATION_HISTORY(EVAL_DATE);

COMMENT ON TABLE ML_EVALUATION_HISTORY IS 'Weekly evaluation run history for trend tracking';

-- =====================================================
-- Grant permissions (adjust schema as needed)
-- =====================================================

-- GRANT SELECT, INSERT, UPDATE ON ML_CONFIG_RECOMMENDATIONS TO cdc_service;
-- GRANT SELECT, INSERT, UPDATE ON ML_CLASSIFICATION_FEEDBACK TO cdc_service;
-- GRANT SELECT, INSERT ON ML_EVALUATION_HISTORY TO cdc_service;

-- =====================================================
-- Verification query
-- =====================================================

SELECT table_name, num_rows
FROM user_tables
WHERE table_name LIKE 'ML_%';
