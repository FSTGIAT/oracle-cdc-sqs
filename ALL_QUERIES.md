# Oracle CDC Service - Complete Query List

## Total Queries: 22

---

## 1. Test Oracle Connection
**Type:** SELECT
**File:** cdc_service.py:119
**Description:** Test Oracle database connection and retrieve current database time

```sql
SELECT SYSDATE FROM dual
```

---

## 2. Check Table Exists (With Schema)
**Type:** SELECT
**File:** cdc_service.py:245-250
**Description:** Check if a table exists in a specific schema

```sql
SELECT COUNT(*)
FROM all_tables
WHERE owner = UPPER(:schema_name) AND table_name = UPPER(:tbl_name)
```

---

## 3. Check Table Exists (Current User Schema)
**Type:** SELECT
**File:** cdc_service.py:252-257
**Description:** Check if a table exists in current user's schema

```sql
SELECT COUNT(*)
FROM user_tables
WHERE table_name = UPPER(:tbl_name)
```

---

## 4. Get Table Row Count
**Type:** SELECT
**File:** cdc_service.py:272
**Description:** Get approximate row count for a table (for validation)

```sql
SELECT COUNT(*) FROM {full_table_name} WHERE ROWNUM <= 1000
```

---

## 5. Create CDC_PROCESSING_STATUS Table
**Type:** CREATE TABLE
**File:** cdc_service.py:293-302
**Description:** Track CDC processing status for different modes (normal and historical)

```sql
CREATE TABLE CDC_PROCESSING_STATUS (
    TABLE_NAME VARCHAR2(100) PRIMARY KEY,
    LAST_PROCESSED_TIMESTAMP TIMESTAMP,
    LAST_CHANGE_ID NUMBER,
    TOTAL_PROCESSED NUMBER DEFAULT 0,
    IS_ENABLED NUMBER DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT SYSTIMESTAMP
)
```

---

## 6. Create CDC_PROCESSED_CALLS Table
**Type:** CREATE TABLE
**File:** cdc_service.py:304-311
**Description:** Track which calls have been processed and sent to SQS

```sql
CREATE TABLE CDC_PROCESSED_CALLS (
    CALL_ID VARCHAR2(50) PRIMARY KEY,
    PROCESSED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    TEXT_TIME TIMESTAMP,
    SQS_MESSAGE_ID VARCHAR2(200)
)
```

---

## 7. Create CDC_PROCESSING_LOG Table
**Type:** CREATE TABLE
**File:** cdc_service.py:313-324
**Description:** Log CDC processing operations with timing and status

```sql
CREATE TABLE CDC_PROCESSING_LOG (
    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BATCH_ID VARCHAR2(50),
    CALL_ID VARCHAR2(50),
    OPERATION_TYPE VARCHAR2(20),
    PROCESSING_TIME_MS NUMBER,
    STATUS VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
)
```

---

## 8. Create ERROR_LOG Table
**Type:** CREATE TABLE
**File:** cdc_service.py:326-335
**Description:** Log errors during processing with retry count

```sql
CREATE TABLE ERROR_LOG (
    ERROR_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    CALL_ID VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    ERROR_TYPE VARCHAR2(100),
    RETRY_COUNT NUMBER DEFAULT 0,
    ERROR_TIMESTAMP TIMESTAMP DEFAULT SYSTIMESTAMP
)
```

---

## 9. Create SQS_PERMANENT_FAILURES Table
**Type:** CREATE TABLE
**File:** cdc_service.py:337-346
**Description:** Track calls that permanently failed to send to SQS

```sql
CREATE TABLE SQS_PERMANENT_FAILURES (
    FAILURE_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    CALL_ID VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    TOTAL_ATTEMPTS NUMBER,
    ORIGINAL_MESSAGE CLOB,
    MARKED_FAILED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
)
```

---

## 10. Create DICTA_CALL_SUMMARY Table
**Type:** CREATE TABLE
**File:** cdc_service.py:348-363
**Description:** Store ML processing results (sentiment, classification, summary) for calls

```sql
CREATE TABLE DICTA_CALL_SUMMARY (
    CALL_ID VARCHAR2(50) PRIMARY KEY,
    CUSTOMER_ID VARCHAR2(50),
    SUBSCRIBER_NO VARCHAR2(50),
    CALL_TIME TIMESTAMP,
    SUMMARY_TEXT CLOB,
    SENTIMENT VARCHAR2(50),
    CLASSIFICATION_PRIMARY VARCHAR2(255),
    CLASSIFICATION_ALL CLOB,
    CONFIDENCE_SCORE NUMBER(5,2),
    ML_PROCESSING_TIME_MS NUMBER,
    ML_MODEL_VERSION VARCHAR2(50),
    PROCESSED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
)
```

---

## 11. Initialize Normal Mode Processing Status
**Type:** MERGE
**File:** cdc_service.py:385-392
**Description:** Initialize CDC_PROCESSING_STATUS for normal mode on first run

```sql
MERGE INTO CDC_PROCESSING_STATUS t
USING (SELECT 'CDC_NORMAL_MODE' AS name FROM dual) s
ON (t.TABLE_NAME = s.name)
WHEN NOT MATCHED THEN
    INSERT (TABLE_NAME, LAST_PROCESSED_TIMESTAMP, IS_ENABLED)
    VALUES ('CDC_NORMAL_MODE', SYSTIMESTAMP - 1, 1)
```

---

## 12. Initialize Historical Mode Processing Status
**Type:** MERGE
**File:** cdc_service.py:394-401
**Description:** Initialize CDC_PROCESSING_STATUS for historical mode (backfill)

```sql
MERGE INTO CDC_PROCESSING_STATUS t
USING (SELECT 'CDC_HISTORICAL_MODE' AS name FROM dual) s
ON (t.TABLE_NAME = s.name)
WHEN NOT MATCHED THEN
    INSERT (TABLE_NAME, LAST_PROCESSED_TIMESTAMP, IS_ENABLED)
    VALUES ('CDC_HISTORICAL_MODE', TO_TIMESTAMP(:start_date, 'YYYY-MM-DD'), 0)
```

---

## 13. Get Normal Mode Processing Status
**Type:** SELECT
**File:** cdc_service.py:426-430
**Description:** Retrieve last processed timestamp and total count for normal mode

```sql
SELECT LAST_PROCESSED_TIMESTAMP, TOTAL_PROCESSED
FROM CDC_PROCESSING_STATUS
WHERE TABLE_NAME = 'CDC_NORMAL_MODE' AND IS_ENABLED = 1
```

---

## 14. Collect New Calls (Normal Mode) - MAIN QUERY
**Type:** SELECT
**File:** cdc_service.py:440-449
**Description:** Fetch new call records from VERINT_TEXT_ANALYSIS from last N minutes

```sql
SELECT DISTINCT CALL_ID, TEXT_TIME
FROM call_analytics.VERINT_TEXT_ANALYSIS
WHERE TEXT_TIME > SYSDATE - ({minutes} / 1440)
AND CALL_ID NOT IN (
    SELECT CALL_ID FROM CDC_PROCESSED_CALLS
)
ORDER BY TEXT_TIME ASC
FETCH FIRST :batch_size ROWS ONLY
```

---

## 15. Get Historical Mode Processing Status
**Type:** SELECT
**File:** cdc_service.py:484-488
**Description:** Retrieve historical mode processing status and enabled state

```sql
SELECT LAST_PROCESSED_TIMESTAMP, IS_ENABLED, TOTAL_PROCESSED
FROM CDC_PROCESSING_STATUS
WHERE TABLE_NAME = 'CDC_HISTORICAL_MODE'
```

---

## 16. Collect Historical Calls (Backfill)
**Type:** SELECT
**File:** cdc_service.py:502-512
**Description:** Fetch historical calls by date range for backfill processing

```sql
SELECT DISTINCT CALL_ID, TEXT_TIME
FROM call_analytics.VERINT_TEXT_ANALYSIS
WHERE TEXT_TIME >= :start_time
AND TEXT_TIME < :start_time + INTERVAL '1' DAY
AND CALL_ID NOT IN (
    SELECT CALL_ID FROM CDC_PROCESSED_CALLS
)
ORDER BY TEXT_TIME ASC
FETCH FIRST :batch_size ROWS ONLY
```

---

## 17. Assemble Conversation - MAIN QUERY
**Type:** SELECT
**File:** cdc_service.py:553-560
**Description:** Fetch all message segments for a specific call by CALL_ID

```sql
SELECT
    CALL_ID, BAN, SUBSCRIBER_NO, OWNER, TEXT_TIME,
    CALL_TIME, DBMS_LOB.SUBSTR(TEXT, 4000, 1) as TEXT
FROM call_analytics.VERINT_TEXT_ANALYSIS
WHERE CALL_ID = :call_id
ORDER BY TEXT_TIME ASC
```

---

## 18. Merge ML Results to DICTA_CALL_SUMMARY - MAIN QUERY
**Type:** MERGE
**File:** cdc_service.py:783-821
**Description:** Insert or update ML processing results (sentiment, classification, summary)

```sql
MERGE INTO DICTA_CALL_SUMMARY t
USING (SELECT :call_id AS call_id FROM dual) s
ON (t.CALL_ID = s.call_id)
WHEN MATCHED THEN
    UPDATE SET
        SUMMARY_TEXT = :summary,
        SENTIMENT = :sentiment,
        CLASSIFICATION_PRIMARY = :classification,
        CLASSIFICATION_ALL = :all_classifications,
        CONFIDENCE_SCORE = :confidence,
        ML_PROCESSING_TIME_MS = :processing_time,
        ML_MODEL_VERSION = :model_version,
        PROCESSED_AT = SYSTIMESTAMP
WHEN NOT MATCHED THEN
    INSERT (
        CALL_ID, CUSTOMER_ID, SUBSCRIBER_NO, CALL_TIME,
        SUMMARY_TEXT, SENTIMENT, CLASSIFICATION_PRIMARY,
        CLASSIFICATION_ALL, CONFIDENCE_SCORE,
        ML_PROCESSING_TIME_MS, ML_MODEL_VERSION
    ) VALUES (
        :call_id, :customer_id, :subscriber_no, TO_TIMESTAMP(:call_time, 'YYYY-MM-DD"T"HH24:MI:SS.FF'),
        :summary, :sentiment, :classification,
        :all_classifications, :confidence,
        :processing_time, :model_version
    )
```

---

## 19. Check Call Already Processed
**Type:** SELECT
**File:** cdc_service.py:847-850
**Description:** Verify if a call has already been marked as processed

```sql
SELECT COUNT(*) FROM CDC_PROCESSED_CALLS
WHERE CALL_ID = :call_id
```

---

## 20. Mark Call Processed
**Type:** INSERT
**File:** cdc_service.py:854-862
**Description:** Insert call into CDC_PROCESSED_CALLS to track processing

```sql
INSERT INTO CDC_PROCESSED_CALLS (CALL_ID, SQS_MESSAGE_ID, TEXT_TIME)
SELECT :call_id, :msg_id, MAX(TEXT_TIME)
FROM call_analytics.VERINT_TEXT_ANALYSIS
WHERE CALL_ID = :call_id
```

---

## 21. Update CDC Processing Status
**Type:** UPDATE
**File:** cdc_service.py:881-890
**Description:** Update last processed timestamp and total processed count after batch

```sql
UPDATE CDC_PROCESSING_STATUS
SET LAST_PROCESSED_TIMESTAMP = :ts,
    TOTAL_PROCESSED = TOTAL_PROCESSED + 1,
    LAST_UPDATED = SYSTIMESTAMP
WHERE TABLE_NAME = :table_name
```

---

## 22. Log Error
**Type:** INSERT
**File:** cdc_service.py:907-914
**Description:** Log processing errors to ERROR_LOG table

```sql
INSERT INTO ERROR_LOG (CALL_ID, ERROR_MESSAGE, ERROR_TYPE)
VALUES (:call_id, :error_msg, :error_type)
```

---

## Summary by Type

| Type | Count |
|------|-------|
| SELECT | 9 |
| INSERT | 3 |
| UPDATE | 1 |
| CREATE | 6 |
| MERGE | 3 |
| **TOTAL** | **22** |

---

## Key Queries Summary

**Data Collection (Core):**
- Query #14: Collect new calls from VERINT_TEXT_ANALYSIS
- Query #16: Collect historical calls for backfill
- Query #17: Assemble conversation segments

**Data Storage (Output):**
- Query #18: Merge ML results to DICTA_CALL_SUMMARY

**Tracking:**
- Query #20: Mark call as processed
- Query #21: Update CDC processing status

**Error Handling:**
- Query #22: Log errors
- Query #19: Check if call already processed

**Setup (First Run):**
- Queries #5-12: Create tables and initialize status

**Testing/Utility:**
- Queries #23-28: Reset and verify data for testing
