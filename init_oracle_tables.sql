-- ============================
-- Oracle CDC Tables Initialization
-- Run this on on-premises Oracle database
-- ============================

SET SERVEROUTPUT ON;

PROMPT ============================
PROMPT Creating CDC Tables
PROMPT ============================

-- Table 1: CDC Processing Status
PROMPT Creating CDC_PROCESSING_STATUS...
CREATE TABLE CDC_PROCESSING_STATUS (
    TABLE_NAME VARCHAR2(100) PRIMARY KEY,
    LAST_PROCESSED_TIMESTAMP TIMESTAMP,
    LAST_CHANGE_ID NUMBER,
    TOTAL_PROCESSED NUMBER DEFAULT 0,
    IS_ENABLED NUMBER DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- Table 2: CDC Processed Calls (Prevent duplicates)
PROMPT Creating CDC_PROCESSED_CALLS...
CREATE TABLE CDC_PROCESSED_CALLS (
    CALL_ID VARCHAR2(50) PRIMARY KEY,
    PROCESSED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
    TEXT_TIME TIMESTAMP,
    SQS_MESSAGE_ID VARCHAR2(200)
);

CREATE INDEX idx_processed_calls_time ON CDC_PROCESSED_CALLS(PROCESSED_AT);

-- Table 3: CDC Processing Log
PROMPT Creating CDC_PROCESSING_LOG...
CREATE TABLE CDC_PROCESSING_LOG (
    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BATCH_ID VARCHAR2(50),
    CALL_ID VARCHAR2(50),
    OPERATION_TYPE VARCHAR2(20),
    PROCESSING_TIME_MS NUMBER,
    STATUS VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE INDEX idx_processing_log_call ON CDC_PROCESSING_LOG(CALL_ID);
CREATE INDEX idx_processing_log_time ON CDC_PROCESSING_LOG(CREATED_AT);

-- Table 4: Error Log
PROMPT Creating ERROR_LOG...
CREATE TABLE ERROR_LOG (
    ERROR_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    CALL_ID VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    ERROR_TYPE VARCHAR2(100),
    RETRY_COUNT NUMBER DEFAULT 0,
    ERROR_TIMESTAMP TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE INDEX idx_error_log_call ON ERROR_LOG(CALL_ID);

-- Table 5: SQS Permanent Failures
PROMPT Creating SQS_PERMANENT_FAILURES...
CREATE TABLE SQS_PERMANENT_FAILURES (
    FAILURE_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
    CALL_ID VARCHAR2(50),
    ERROR_MESSAGE CLOB,
    TOTAL_ATTEMPTS NUMBER,
    ORIGINAL_MESSAGE CLOB,
    MARKED_FAILED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- Table 6: DICTA Call Summary (ML Results)
PROMPT Creating DICTA_CALL_SUMMARY...
CREATE TABLE DICTA_CALL_SUMMARY (
    CALL_ID VARCHAR2(50) PRIMARY KEY,
    CUSTOMER_ID VARCHAR2(50),
    SUBSCRIBER_NO VARCHAR2(50),
    CALL_TIME TIMESTAMP,
    SUMMARY_TEXT CLOB,
    SENTIMENT VARCHAR2(50),
    CLASSIFICATION_PRIMARY VARCHAR2(255),
    CLASSIFICATION_ALL CLOB,
    CONFIDENCE_SCORE NUMBER(5,2),
    ML_PROCESSING_TIME_MS NUMBER,
    ML_MODEL_VERSION VARCHAR2(50),
    PROCESSED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE INDEX idx_dicta_summary_customer ON DICTA_CALL_SUMMARY(CUSTOMER_ID);
CREATE INDEX idx_dicta_summary_sentiment ON DICTA_CALL_SUMMARY(SENTIMENT);
CREATE INDEX idx_dicta_summary_time ON DICTA_CALL_SUMMARY(CALL_TIME);

-- Initialize CDC Status
PROMPT Initializing CDC_PROCESSING_STATUS...
INSERT INTO CDC_PROCESSING_STATUS (TABLE_NAME, LAST_PROCESSED_TIMESTAMP, IS_ENABLED)
VALUES ('CDC_NORMAL_MODE', SYSTIMESTAMP - 1, 1);

INSERT INTO CDC_PROCESSING_STATUS (TABLE_NAME, LAST_PROCESSED_TIMESTAMP, IS_ENABLED)
VALUES ('CDC_HISTORICAL_MODE', TO_TIMESTAMP('2024-01-01', 'YYYY-MM-DD'), 0);

COMMIT;

PROMPT ============================
PROMPT Verification
PROMPT ============================

-- Verification queries
SELECT 'Tables created successfully!' AS STATUS FROM dual;

PROMPT
PROMPT List of CDC Tables:
PROMPT

SELECT TABLE_NAME, TO_CHAR(CREATED, 'YYYY-MM-DD HH24:MI:SS') AS CREATED
FROM USER_TABLES
WHERE TABLE_NAME IN (
    'CDC_PROCESSING_STATUS',
    'CDC_PROCESSED_CALLS',
    'CDC_PROCESSING_LOG',
    'ERROR_LOG',
    'SQS_PERMANENT_FAILURES',
    'DICTA_CALL_SUMMARY'
)
ORDER BY TABLE_NAME;

PROMPT
PROMPT CDC Processing Status:
PROMPT

SELECT * FROM CDC_PROCESSING_STATUS;

PROMPT
PROMPT ============================
PROMPT Setup Complete!
PROMPT ============================
